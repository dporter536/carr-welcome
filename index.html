<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Welcome – Carrick-a-Rede Retreat</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--glass-bg:rgba(255,255,255,.08);--glass-bd:rgba(255,255,255,.18);}
  html,body{height:100%;margin:0;background:#0b0f0d;color:#fff;font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

  /* Background layers */
  .stage{position:fixed;inset:0;overflow:hidden}
  video.bg{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;opacity:0;transition:opacity .9s ease}
  .slides{position:absolute;inset:0;opacity:0;transition:opacity .9s ease}
  .slide{position:absolute;inset:0;background-size:cover;background-position:center;opacity:0;transition:opacity 1.2s ease}
  .slide.active{opacity:1}
  .visible{opacity:1}

  /* Branding + card */
  .brand{position:fixed;top:24px;left:24px;display:flex;gap:12px;align-items:center;z-index:3}
  .brand img{height:120px;width:auto;filter:drop-shadow(0 2px 8px rgba(0,0,0,.35))}
  .brand .tag{font-weight:600;letter-spacing:.08em;opacity:.85;text-transform:uppercase}

  .wrap{position:relative;z-index:2;height:100%;display:grid;place-items:center;text-align:center;padding:5vmin}
  .card{backdrop-filter:blur(10px);background:var(--glass-bg);border:1px solid var(--glass-bd);border-radius:24px;
        padding:4vmin 6vmin;max-width:86ch;box-shadow:0 10px 40px rgba(0,0,0,.45)}
  h1{font-size:clamp(2.2rem,4vw + 1rem,4.6rem);margin:1rem 0 .25rem;line-height:1.05}
  h2{font-size:clamp(1.05rem,1.2vw + .8rem,1.6rem);font-weight:600;opacity:.95;margin:.2rem 0 .8rem}
  .meta{opacity:.92;font-size:1.05rem;letter-spacing:.02em}
  .small{opacity:.78;font-size:.95rem;margin-top:1rem}
  .spinner{width:36px;height:36px;border:3px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite;margin:2rem auto 0}
  @keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<!-- Background: video + slideshow -->
<div class="stage">
  <video id="bgVideo" class="bg" autoplay muted playsinline preload="auto">
    <source src="assets/video.mp4" type="video/mp4">
  </video>
  <div id="slides" class="slides">
    <div class="slide" style="background-image:url('assets/DJI_0868.JPG')"></div>
    <div class="slide" style="background-image:url('assets/DJI_0970.JPG')"></div>
    <div class="slide" style="background-image:url('assets/IMG_4182-EDIT-1.jpg')"></div>
  </div>
</div>

<!-- Branding -->
<div class="brand">
  <img src="assets/logo.png" alt="Carrick-a-Rede Retreat logo">
  <div class="tag">Causeway Coast</div>
</div>

<!-- Welcome card -->
<div class="wrap">
  <div class="card">
    <h1 id="headline">Welcome</h1>
    <h2 id="sub">Relax, unwind & enjoy the view.</h2>
    <div class="meta" id="meta">Loading your stay details…</div>
    <div class="small" id="extra">If details look wrong, don’t worry — your stay is confirmed. We’ll update shortly.</div>
    <div class="spinner" id="spin"></div>
  </div>
</div>

<script>
(async () => {
  /* ---------- CONFIG ---------- */
  const API = 'https://script.google.com/macros/s/AKfycby8ZTL2LoFxGjKrVHIsShHb1Z722mZxUvi0YyHXuuTgBEn2XCtMyfny7tvuEIzn0STAEg/exec';
  const params = new URLSearchParams(location.search);
  const cabinParam = params.get('cabin') || 'C1';
  const up = cabinParam.toUpperCase();
  const cabinLabel = up==='C1'?'Cabin 1':up==='C2'?'Cabin 2':up==='C3'?'Cabin 3':cabinParam;

  /* ---------- FETCH & RENDER ---------- */
  try {
    const r = await fetch(`${API}?cabin=${encodeURIComponent(cabinParam)}&v=${Date.now()}`, { cache:'no-store' });
    const j = await r.json();

    const headline = document.getElementById('headline');
    const sub = document.getElementById('sub');
    const meta = document.getElementById('meta');
    const extra = document.getElementById('extra');
    document.getElementById('spin').style.display = 'none';

    const plural=(n,w)=>n===1?w:w+'s';
    const pretty=(iso)=> iso ? new Date(iso+'T00:00:00').toLocaleDateString('en-GB',{weekday:'short',day:'numeric',month:'short'}) : null;

    // compute fallbacks if API missed any fields
    let { nights, stayNight, checkoutPretty, checkinISO, checkoutISO } = j;
    if (!nights && checkinISO && checkoutISO) {
      const ms = new Date(checkoutISO) - new Date(checkinISO);
      nights = Math.max(1, Math.round(ms/86400000));
    }
    if (!checkoutPretty) checkoutPretty = pretty(checkoutISO);
    if (!stayNight && nights && checkinISO) {
      const todayISO = new Date().toISOString().slice(0,10);
      const idx = Math.max(1, Math.round((new Date(todayISO) - new Date(checkinISO))/86400000) + 1);
      stayNight = `${idx} of ${nights}`;
    }

    if (j.success && j.guestName) {
      const first = j.guestName.trim().split(/\s+/)[0];
      headline.textContent = `Welcome, ${first}!`;
      sub.textContent = `${cabinLabel} • ${j.dateISO}`;
      if (stayNight && nights && checkoutPretty) {
        meta.textContent = `Night ${stayNight} • Staying ${nights} ${plural(nights,'night')} • Checkout ${checkoutPretty} • 11:30am`;
      } else if (nights && checkoutPretty) {
        meta.textContent = `Staying ${nights} ${plural(nights,'night')} • Checkout ${checkoutPretty} • 11:30am`;
      } else if (checkoutPretty) {
        meta.textContent = `Checkout ${checkoutPretty} • 11:30am`;
      } else {
        meta.textContent = 'We’re thrilled to host you. The hot tub is ready — have an amazing stay.';
      }
      extra.textContent = '';
    } else if (j.success) {
      headline.textContent = 'Welcome to Carrick-a-Rede Retreat';
      sub.textContent = cabinLabel;
      meta.textContent = `Today: ${new Date().toLocaleDateString('en-GB')}`;
      extra.textContent = j.phase==='neutral_changeover' ? 'Housekeeping in progress — we’ll have everything perfect for your arrival.' : '';
    } else {
      headline.textContent = 'Welcome';
      sub.textContent = cabinLabel;
      meta.textContent = 'Unable to load booking details right now.';
      extra.textContent = '';
    }
  } catch {
    document.getElementById('spin').style.display='none';
  }

  /* ---------- VIDEO → SLIDESHOW → VIDEO LOOP (robust) ---------- */
  const video = document.getElementById('bgVideo');
  const slidesWrap = document.getElementById('slides');
  const slides = Array.from(slidesWrap.querySelectorAll('.slide'));
  let slideIdx = 0, slideTimer = null, backToVideoTimer = null;

  function startSlideshow() {
    video.classList.remove('visible');
    slidesWrap.classList.add('visible');
    slides.forEach(s=>s.classList.remove('active'));
    slideIdx = 0;
    slides[0].classList.add('active');
    clearInterval(slideTimer);
    slideTimer = setInterval(()=>{
      slides[slideIdx].classList.remove('active');
      slideIdx = (slideIdx + 1) % slides.length;
      slides[slideIdx].classList.add('active');
    }, 8000);
  }

  function showVideoThenReturn() {
    const hasFrames = () => video.readyState >= 2 && video.videoWidth > 0;
    const switchToVideo = () => {
      if (!hasFrames()) return;
      slidesWrap.classList.remove('visible');
      video.classList.add('visible');
      try { video.currentTime = 0; video.play().catch(()=>{}); } catch(e){}
      const dur = (isFinite(video.duration) && video.duration > 2) ? video.duration*1000 : 30000;
      clearTimeout(backToVideoTimer);
      backToVideoTimer = setTimeout(startSlideshow, dur);
    };
    if (hasFrames()) switchToVideo();
    else {
      video.addEventListener('loadeddata', switchToVideo, { once:true });
      video.addEventListener('canplay',    switchToVideo, { once:true });
      video.addEventListener('error',      () => {},      { once:true });
      try { video.play().catch(()=>{}); } catch(e){}
      setTimeout(() => { if (!hasFrames()) {/* keep slideshow */} }, 8000);
    }
  }

  startSlideshow();          // show images immediately
  showVideoThenReturn();     // fade to video only when it has frames

  /* ---------- AUTO REFRESH ---------- */
  function scheduleReloads(times){
    const now=new Date();
    for(const [h,m] of times){
      const t=new Date(); t.setHours(h,m,0,0);
      if(t<=now) t.setDate(t.getDate()+1);
      setTimeout(()=>location.reload(), t-now);
    }
  }
  setInterval(()=>location.reload(), 30*60*1000); // heartbeat 30 min
  scheduleReloads([[7,28],[11,31],[14,31]]);
})();
</script>
</body>
</html>
